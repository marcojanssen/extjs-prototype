/*!
 * Ext.ux.Router
 * http://github.com/brunotavares/Ext.ux.Router
 *
 * Copyright 2012 Bruno Tavares
 * Released under the MIT license
 * Check MIT-LICENSE.txt
 */
Ext.define("Ext.ux.Router",{singleton:true,alternateClassName:"Ext.Router",mixins:{observable:Ext.util.Observable},constructor:function(){var a=this;a.ready=false;a.routes=[];a.mixins.observable.constructor.call(a)},init:function(c){var a=this,b=Ext.History;if(!c||!c.routes){return}a.processRoutes(c);if(a.ready){return}a.ready=true;a.addEvents("routemissed","beforedispatch","dispatch");b.init();b.on("change",a.parse,a);Ext.onReady(function(){a.parse(b.getToken())})},processRoutes:function(c){var a,b=c.routes;for(a in b){if(b.hasOwnProperty(a)){this.routeMatcher(c,a,b[a])}}},routeMatcher:function(a,h,k){var g,b,f=this,j=f.routes,d=h,i=/([:*])(\w+)/g,c=/([-.+?\^${}()|\[\]\/\\])/g,e=[];if(k.regex){g={app:a,route:h,regex:k.regex,controller:k.controller,action:k.action};delete k.controller;delete k.action;g.rules=k}else{d=d.replace(c,"\\$1").replace(i,function(m,n,l){e.push(l);return n===":"?"([^/]*)":"(.*)"});g={app:a,route:h,names:e,matcher:new RegExp("^"+d+"$"),manageArgs:h.indexOf("?")!==-1};if(Ext.isString(k)){b=k.split("#");g.controller=b[0];g.action=b[1];g.rules=undefined}else{g.controller=k.controller;g.action=k.action;delete k.controller;delete k.action;g.rules=k}}j.push(g)},parse:function(b){var o,f,c,l,d,a,n,q,m,h,k=this,p=k.routes,e=0,g=p.length;b=b||"";h=b.split("?");m=h[1];h=h[0];for(;e<g;e++){o=p[e];if(o.regex){f=b.match(o.regex);if(f){f=f.slice(1);if(k.dispatch(b,o,f)){return{captures:f}}}}else{f=o.manageArgs?b.match(o.matcher):h.match(o.matcher);if(h===""&&o.route==="/"||h==="/"&&o.route===""){f=[]}if(f){c={};l=o.names;q=o.rules;d=0;while(d<l.length){a=l[d++];n=f[d];if(q&&a in q&&!this.validateRule(q[a],n)){f=false;break}c[a]=n}if(m&&!o.manageArgs){c=Ext.applyIf(c,Ext.Object.fromQueryString(m))}if(f&&k.dispatch(b,o,c)){return c}}}}k.fireEvent("routemissed",b);return false},validateRule:function(b,a){if(Ext.isFunction(b)){return b(a)}else{if(Ext.isFunction(b.test)){return b.test(a)}}return b===a},dispatch:function(c,b,e){var a,d=this;if(d.fireEvent("beforedispatch",c,b,e)===false){return false}a=d.getController(b);if(!a){return false}a[b.action].call(a,e,c,b);d.fireEvent("dispatch",c,b,e,a);return true},redirect:function(a,b){var c=Ext.History;if(b!==false&&c.getToken()===a){this.parse(a)}else{c.add(a)}},getController:function(b){var f,d,e=b.app,c=Ext.ClassManager,a=b.controller;f=e.getModuleClassName(a,"controller");if(!c.get(f)){a=Ext.String.capitalize(a);f=e.getModuleClassName(a,"controller");if(!c.get(f)){return false}b.controller=a}return e.getController(a)}},function(){Ext.override(Ext.app.Application,{enableRouter:true,onBeforeLaunch:function(){this.callOverridden();if(this.enableRouter){Ext.ux.Router.init(this)}}})});